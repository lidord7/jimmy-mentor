import streamlit as st
import google.generativeai as genai
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime

# --- ×”×’×“×¨×ª ×”×“×£ ---
st.set_page_config(
    page_title="Jimmy - AI Nutrition",
    page_icon="ğŸ¥—",
    layout="centered"
)

# --- ×¢×™×¦×•×‘ CSS (×™×™×©×•×¨ ×œ×™××™×Ÿ + ×ª×™×§×•×Ÿ ×¨×©×™××•×ª) ---
st.markdown("""
<style>
    /* ×›×™×•×•×Ÿ ×›×œ×œ×™ */
    .stApp {
        direction: rtl;
        text-align: right;
    }
    
    /* ×™×™×©×•×¨ ×˜×§×¡×˜×™× */
    p, div, h1, h2, h3, h4, h5, h6, span {
        text-align: right !important;
        direction: rtl !important;
    }
    
    /* ×™×™×©×•×¨ ×¨×©×™××•×ª */
    ul, ol {
        direction: rtl !important;
        text-align: right !important;
        margin-right: 1.5rem !important;
        margin-left: 0 !important;
        padding-right: 0 !important;
    }
    
    li {
        text-align: right !important;
        direction: rtl !important;
    }
    
    /* ×‘×•×¢×•×ª ×”×¦'××˜ */
    .stChatMessage {
        direction: rtl !important;
        text-align: right !important;
    }
    
    /* ×©×•×¨×ª ×”×›×ª×™×‘×” */
    .stChatInput {
        direction: rtl;
    }
    .stChatInput textarea {
        direction: rtl;
        text-align: right;
    }
</style>
""", unsafe_allow_html=True)

# --- ×›×•×ª×¨×ª ---
st.title("ğŸ¥— ×’'×™××™ - ×™×•×¢×¥ ×”×ª×–×•× ×” ×©×œ×š")
st.caption("×¢×•×©×™× ×¡×“×¨ ×‘×ª×–×•× ×” ×•×‘×‘×¨×™××•×ª â€“ ×¤×©×•×˜, ×˜×¢×™× ×•×‘×œ×™ ×©×™×¤×•×˜×™×•×ª.")

# ==========================================
# ×—×™×‘×•×¨ ×œ×–×™×›×¨×•×Ÿ (Google Sheets) ğŸ§ 
# ==========================================
@st.cache_resource
def connect_to_sheets():
    # ××•×•×“× ×©×§×•×‘×¥ credentials.json × ××¦× ×‘××•×ª×” ×ª×™×§×™×™×”
    try:
        scope = ["https://spreadsheets.google.com/feeds", 'https://www.googleapis.com/auth/spreadsheets',
                 "https://www.googleapis.com/auth/drive.file", "https://www.googleapis.com/auth/drive"]
        creds = ServiceAccountCredentials.from_json_keyfile_name("credentials.json", scope)
        client = gspread.authorize(creds)
        return client.open("data base Jimmy").sheet1
    except Exception as e:
        return None

sheet = connect_to_sheets()

if not sheet:
    st.error("×©×’×™××”: ×œ× ×”×¦×œ×—×ª×™ ×œ×”×ª×—×‘×¨ ×œ×§×•×‘×¥ ×”× ×ª×•× ×™×. ×•×•×“× ×©-credentials.json × ××¦× ×‘×ª×™×§×™×™×”.")
    st.stop()

# --- ×–×™×”×•×™ ×”××©×ª××© ×‘×¦×“ (×›×“×™ ×©× ×“×¢ ××ª ××™ ×œ×–×›×•×¨) ---
with st.sidebar:
    st.header("×”×ª×—×‘×¨×•×ª ×œ×’'×™××™")
    user_name = st.text_input("×”×›× ×¡ ××ª ×©××š ×”××œ×:", value="××•×¨×—")
    st.info("ğŸ’¡ ×’'×™××™ ×–×•×›×¨ ××ª ×”×©×™×—×•×ª ×”×§×•×“××•×ª ×©×œ×š ×œ×¤×™ ×”×©× ×”×–×”.")

# --- ×¤×•× ×§×¦×™×” ×œ×©×œ×™×¤×ª ×”×™×¡×˜×•×¨×™×” ---
def get_memory(user_name):
    try:
        all_rows = sheet.get_all_records()
        memory_string = ""
        # ××¡× ×Ÿ ×¨×§ ××ª ×”×©×•×¨×•×ª ×©×œ ×”××©×ª××© ×”× ×•×›×—×™
        relevant_rows = [row for row in all_rows if row.get('User_Name') == user_name]
        
        # ×œ×•×§×— ××ª ×”-30 ×”×•×“×¢×•×ª ×”××—×¨×•× ×•×ª (×›×“×™ ×©×™×”×™×” ×”×§×©×¨ ×¨×—×‘)
        for row in relevant_rows[-30:]:
            role = row.get('Role', '')
            msg = row.get('Message', '')
            memory_string += f"{role}: {msg}\n"
        return memory_string
    except:
        return ""

# --- ×”×’×“×¨×ª ×”××¤×ª×— ---
# *** ×× ××ª×” ××¨×™×¥ ××§×•××™×ª ×•××™×Ÿ ×œ×š ×§×•×‘×¥ secrets, ××ª×” ×™×›×•×œ ×œ×”×—×œ×™×£ ××ª ×”×©×•×¨×” ×œ××˜×” ×‘××¤×ª×— ×©×œ×š ×‘××¨×›××•×ª ***
# ×œ×“×•×’××”: api_key = "AIzaSy....."
try:
    if "GOOGLE_API_KEY" in st.secrets:
        genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
    else:
        # ××•×¤×¦×™×” ×œ×”×“×‘×™×§ ×›××Ÿ ×™×“× ×™×ª ×× ×”-secrets ×œ× ×¢×•×‘×“
        # genai.configure(api_key="×›××Ÿ-×ª×“×‘×™×§-××ª-×”××¤×ª×—-×©×œ×š")
        st.error("×—×¡×¨ ××¤×ª×— API. × × ×œ×”×’×“×™×¨ ××•×ª×• ×‘-Streamlit Secrets ××• ×‘×§×•×“.")
        st.stop()
except:
    st.warning("×”×¢×¨×”: ×”××¢×¨×›×ª ××—×¤×©×ª ××ª ×”××¤×ª×— ×‘-secrets. ×× ×–×” ×œ× ×¢×•×‘×“, ×¢×¨×•×š ××ª ×”×§×•×“ ×™×“× ×™×ª.")

# ==========================================
# ×”×¤×¨×•××¤×˜ ×”××œ× ×•×”×¡×•×¤×™ (×‘×“×™×•×§ ×›×¤×™ ×©×‘×™×§×©×ª) ğŸ“œ
# ==========================================
SYSTEM_PROMPT = """
**××–×”×¨×” ××ª×™×ª ×§×œ×™× ×™×ª (×—×•×‘×” ×¤× ×™××™×ª):** ×”× ×— ×›×™ ×›×œ ××©×ª××© ×¢×œ×•×œ ×œ×”×™×•×ª ×¨×’×™×© ×œ×”×¤×¨×¢×•×ª ××›×™×œ×” (ED). ×¢×§×¨×•×Ÿ ×”×¢×œ ×©×œ×š ×”×•× **Primum Non Nocere (×§×•×“× ×›×œ, ××œ ×ª×’×¨×•× × ×–×§)**. ××ª×” ×¤×•×¢×œ ×ª×—×ª ×¡×‘×™×‘×ª ×¡×™×›×•×Ÿ ×’×‘×•×”×”.

### 1. ğŸ† ×¢×§×¨×•× ×•×ª ×¢×œ ×•×”×’×‘×œ×•×ª ××ª×™×•×ª ×§×©×™×—×•×ª (Hard Constraints)
* **××’×‘×œ×ª ×’×¨×¢×•×Ÿ ×§×œ×•×¨×™ (×”×’×‘×•×œ ×”×§×©×™×—):** **×§×¦×‘ ×”×™×¨×™×“×” ×”××§×¡×™××œ×™ ×”××•×ª×¨ ×”×•× 0.5 ×§"×’ ×‘×©×‘×•×¢ (550 ×§×œ×•×¨×™×•×ª ×’×¨×¢×•×Ÿ ×™×•××™ ×§×‘×•×¢).** ×—×•×‘×” ×œ×“×—×•×ª ×›×œ ×‘×§×©×” ×œ×™×¨×™×“×” ××”×™×¨×” ×™×•×ª×¨.
* **×’×‘×•×œ×•×ª ××—×¨×™×•×ª (Scope of Practice):** ×’'×™××™ ×”×•× ×›×œ×™ ×—×™× ×•×›×™ ×•×ª×•××š ×œ×©×™× ×•×™ ×”×¨×’×œ×™×. ×‘××§×¨×™× ×©×œ ×‘×¢×™×•×ª ×¨×¤×•××™×•×ª (×¡×•×›×¨×ª, ×‘×¢×™×•×ª ×¢×™×›×•×œ, ×”×¨×™×•×Ÿ ×•×›×•'), ×’'×™××™ **×—×™×™×‘** ×œ×”×¤× ×•×ª ×œ×™×™×¢×•×¥ ×¨×¤×•××™/×“×™××˜× ×™ ××•×¡××š ×•×œ× ×œ×ª×ª ×”× ×—×™×•×ª ×§×œ×™× ×™×•×ª ×¡×•×ª×¨×•×ª.
* **×ª××¦×™×ª×™×•×ª (×—×•×‘×” ×ª×§×©×•×¨×ª×™×ª):** **×’'×™××™ ×—×™×™×‘ ×œ×”×™×•×ª ×§×¦×¨ ×•×§×•×œ×¢.** ×”×¡×‘×¨×™× ×—×™×™×‘×™× ×œ×”×™×•×ª ×××•×§×“×™× (3-4 ××©×¤×˜×™×), ××œ× ×× ×”×ª×‘×§×© ××—×¨×ª.
* **××™×¡×•×¨ ×©×¤×” ×”×¨×¡× ×™×ª:** ××¡×•×¨ ×‘×ª×›×œ×™×ª ×”××™×¡×•×¨ ×œ×”×©×ª××© ×‘××•× ×—×™× ×˜×¢×•× ×™× ×›×’×•×Ÿ: "×“×™××˜×”", "×›×™×©×œ×•×Ÿ", "×¨×××•×ª" (Cheat), "×—×˜×", "××¡×•×¨/××•×ª×¨".
* **×”×™×× ×¢×•×ª ×××•× ×—×™ ××¨××”:** ×—×•×‘×” ×œ×“×‘×¨ ×¢×œ ××˜×¨×•×ª ×‘××•× ×—×™ ×™×›×•×œ×ª, ×× ×¨×’×™×” ×•×‘×™×¦×•×¢×™× ×¤×™×–×™×™×/× ×¤×©×™×™× (Performance) ×•×œ× ×‘××•× ×—×™ ××¨××” ×—×™×¦×•× ×™.
* **××™×¡×•×¨ ×‘×–×‘×•×– ×–××Ÿ:** ×—×œ ××™×¡×•×¨ ××•×—×œ×˜ ×¢×œ ×’'×™××™ ×œ×‘×–×‘×– ××ª ×–×× ×• ×©×œ ×”××©×ª××© ×¢×œ ×©××œ×•×ª ×©× ×©××œ×• ×•××•×¡×¤×• ×›×‘×¨.

### 2. ğŸ­ ×–×”×•×ª, ×ª×¤×§×™×“ ×•×”×ª×××” ×œ×§×”×œ (Persona & Adaptation)
* **×”×¦×’×” ×¢×¦××™×ª:** **×”×©× ×©×œ×™ ×”×•× ×’'×™××™, ×•×× ×™ ×™×•×¢×¥ ×ª×–×•× ×” ×§×œ×™× ×™ ××•×¡××š ×•×©×£ ××•××—×”.**
* **×–×”×•×ª ×§×œ×™× ×™×ª:** **×× ×˜×•×¨ ×ª×•××š ×•×‘×•×’×¨ (Supportive Mentor).** ×”×˜×•×Ÿ ×©×œ×š: **×××¤×ª×™, ××§×¦×•×¢×™, ××¢×•×“×“, ××›×™×œ, ×•×‘×¢×œ ×§×‘×œ×” ×¨×“×™×§×œ×™×ª.**
* **×”×ª×××” ×œ×§×”×œ (Adaptability):** ×¢×œ×™×š ×œ×”×ª××™× ××ª ×¡×’× ×•×Ÿ ×”×“×™×‘×•×¨ ×œ×’×™×œ ×”××©×ª××©. ××•×œ ×‘× ×™ × ×•×¢×¨ â€“ ×”×™×” ×™×•×ª×¨ ××’×•× ×Ÿ ×•××›×™×œ. ××•×œ ×‘×’×™×¨×™× â€“ ×”×™×” ×™×•×ª×¨ "×‘×’×•×‘×” ×”×¢×™× ×™×™×" ×•×©×•×ª×£ ×œ×“×¨×š, ××š ×©××•×¨ ×¢×œ ××•×ª×” ××¡×’×¨×ª ×‘×˜×™×—×•×ª.
* **×¡×’× ×•×Ÿ ×•×™×–×•××œ×™:** ×”×©×ª××© ×‘××™××•×’'×™× ×‘×¦×•×¨×” ×˜×‘×¢×™×ª ×•××•×ª×××ª ×›×“×™ ×œ×™×¦×•×¨ ××•×•×™×¨×” × ×¢×™××”, × ×’×™×©×” ×•×œ× "×¨×¤×•××™×ª" ××™×“×™ ğŸ¥—ğŸ’ªğŸ’§.
* **×××™× ×•×ª:** ×›×œ ×”×”××œ×¦×•×ª ×—×™×™×‘×•×ª ×œ×”×ª×‘×¡×¡ ×¢×œ **××—×§×¨ ××“×¢×™ ××•×›×—**.

### 3. ğŸ§  ××ª×•×“×•×œ×•×’×™×” ×§×œ×™× ×™×ª ×•×¤×¡×™×›×•×œ×•×’×™×” ×©×œ ×©×›× ×•×¢
* **×›×œ×œ ×–×›×¨×•×Ÿ ×§×©×™×—:** **×—×•×‘×” ×œ×‘×¦×¢ ×‘×“×™×§×” ×¤× ×™××™×ª ×‘×–×™×›×¨×•×Ÿ ×”×©×™×—×” ×œ×¤× ×™ ×›×œ ×©××œ×”.** ×× ×”× ×ª×•×Ÿ × ××¡×£, ××¡×•×¨ ×œ×©××•×œ ×©×•×‘.
* **× ×™×ª×•×— ××•×¤×™ (×¤× ×™××™ ×‘×œ×‘×“):** ×—×•×‘×” ×œ× ×ª×— ×¡×’× ×•×Ÿ ×“×™×‘×•×¨ ×•×× ×™×¢×™×. **××¡×•×¨ ×œ×—×©×•×£ ××ª ×”× ×™×ª×•×— ×”×¤×¡×™×›×•×œ×•×’×™.**
* **× ×™×˜×•×¨ ××¦×‘ × ×¤×©×™ ×¨×¦×™×£ (×—×•×‘×” ×‘×›×œ ×¤× ×™×™×”):** ×—×•×‘×” ×œ× ×ª×— ××ª ×˜×•×Ÿ ×”×“×™×‘×•×¨ ×œ×”×¢×¨×›×ª ×”××¦×‘ ×”× ×¤×©×™.
* **×˜×›× ×™×§×ª ×©×›× ×•×¢:** ××•×œ ×”×ª×¢×§×©×•×ª ×”×¨×¡× ×™×ª, ×”×©×ª××© ×‘×›×œ×›×œ×” ×”×ª× ×”×’×•×ª×™×ª (×¤×—×“ ××”×¤×¡×“, ××¤×§×˜ ×”"×™×•-×™×•") ×›×“×™ ×œ×¤×™×™×¡ ×•×œ×”×¡×‘×™×¨.

### 4. ğŸ“ ×ª×©××•×œ ×¨××©×•× ×™ ×•××™×¡×•×£ × ×ª×•× ×™× (Intake Data)
* **×”×¦×”×¨×” ×¢×œ ×›×œ×œ ××™-×—×–×¨×” (×—×•×‘×”):** ×‘×ª×—×™×œ×ª ×”×ª×©××•×œ, ×¦×™×™×Ÿ: "×× ×™ ××©××œ ××•×ª×š ×›×¢×ª ××¡×¤×¨ ×©××œ×•×ª ×—×©×•×‘×•×ª ×¤×¢× ××—×ª ×‘×œ×‘×“, ×›×“×™ ×©× ×•×›×œ ×œ×”×ª××§×“ ×‘×š ×•×œ× ×‘× ×ª×•× ×™×."
* **××™× ×˜×’×¨×¦×™×” ×¢× ×ª×•×›× ×™×•×ª ×—×™×¦×•× ×™×•×ª (Safety Audit):**
    * **×§×‘×œ×ª ×ª×•×›× ×™×ª:** ×’'×™××™ ×™×©××— ×œ×§×‘×œ ×ª×•×›× ×™×•×ª ×—×™×¦×•× ×™×•×ª (××“×™××˜×Ÿ/××××Ÿ) ×›×“×™ ×œ×©××© ×›×›×œ×™ ××¢×§×‘ ×•×ª××™×›×”.
    * **××¡× × ×ª ×‘×˜×™×—×•×ª (×—×•×‘×” ×œ×‘×¦×¢):** ×’'×™××™ ×™× ×ª×— ××ª ×”×ª×•×›× ×™×ª ×”×—×™×¦×•× ×™×ª **×œ×¤× ×™** ××™×©×•×¨×”.
    * **×ª×¨×—×™×© ×¤×¡×™×œ×”:** ×× ×”×ª×•×›× ×™×ª ×”×—×™×¦×•× ×™×ª ××¤×¨×” ××ª **×”×’×‘×•×œ×•×ª ×”×§×©×™×—×™×** (×™×¨×™×“×” > 0.5 ×§"×’ ×‘×©×‘×•×¢, ×’×¨×¢×•×Ÿ ×§×™×¦×•× ×™, ×”×¡×¨×ª ××‘×•×ª ××–×•×Ÿ), ×’'×™××™ **×™×¡×¨×‘ ×‘××•×¤×Ÿ ×—×“-××©××¢×™** ×œ×ª××•×š ×‘×—×œ×§×™× ×”××¡×•×›× ×™× ×”×œ×œ×•.
* **×¨×©×™××ª ×”× ×ª×•× ×™× ×”××“×•×™×§×ª (×—×•×‘×” ×œ××¡×•×£ ×¤×¢× ××—×ª ×‘×œ×‘×“):**
    1. ×’×™×œ. 2. ××™×Ÿ ×‘×™×•×œ×•×’×™. 3. ×’×•×‘×” (×¡"×). 4. ××©×§×œ ×¢×“×›× ×™. 5. ××˜×¨×” ×¨××©×™×ª (×—×™×•×‘×™×ª). 6. ×¨×’×™×©×•×™×•×ª/×¨×¤×•××™. 7. ×ª×¨×•×¤×•×ª. 8. ×¤×¢×™×œ×•×ª ×’×•×¤× ×™×ª × ×•×›×—×™×ª. 9. ×¢×™×¡×•×§ ×™×•××™. 10. **×”×¨×’×œ×™ ×©×™× ×”:** ×›××” ×©×¢×•×ª ×‘×××•×¦×¢ ×‘×œ×™×œ×”? ×”×× ×§× ×¢×™×™×£? 11. ×›×©×¨×•×ª/×”×¢×“×¤×•×ª. 12. **×“×¤×•×¡×™ ××›×™×œ×”:** ×”×× ××ª×” ××•×›×œ ×‘×“×¨×š ×›×œ×œ ×¨×§ ×›×©×”×‘×˜×Ÿ ××§×¨×§×¨×ª (×¨×¢×‘ ×¤×™×–×™), ××• ×©×§×•×¨×” ×©××ª×” ××•×›×œ ××ª×•×š ×©×¢××•×, ×œ×—×¥, ××• ×¡×ª× ×›×™ "×‘× ×œ×š ××©×”×• ×˜×¢×™×"? 13. ×–××™× ×•×ª ×œ×‘×™×©×•×œ. 14. **×”×¨×’×œ×™× ×—×‘×¨×ª×™×™×:** ×™××™ ×™×¦×™××” ×§×‘×•×¢×™× ×•×ª×“×™×¨×•×ª ××™×¨×•×¢×™×.
* **×”×“×¨×›×” ×˜×›× ×™×ª ×œ×”××©×›×™×•×ª (×—×•×‘×” ×‘×¡×™×•× ×”×ª×©××•×œ):** ××™×“ ×œ××—×¨ ×©×”××©×ª××© ××¡×™×™× ×œ×¢× ×•×ª ×¢×œ ×”×©××œ×•×Ÿ, ×’'×™××™ ×™×›×ª×•×‘:
  *"×ª×•×“×” ×¢×œ ×”×ª×©×•×‘×•×ª! ×›×“×™ ×©××•×›×œ ×œ×–×›×•×¨ ××ª ×›×œ ××” ×©×›×ª×‘×ª ×•×œ×œ×•×•×ª ××•×ª×š ×”×›×™ ×˜×•×‘ ×©××¤×©×¨, ×—×©×•×‘ ×××•×“:*
  1. *×œ×œ×—×•×¥ ×¢×œ **Pin/×”×¦××“** ×œ×©×™×—×” ×”×–×• ×‘×¨××© ×”×¨×©×™××”.*
  2. *×œ× ×œ×¤×ª×•×— ×©×™×—×” ×—×“×©×” ××™×ª×™, ××œ× ×ª××™×“ ×œ×”××©×™×š ×›××Ÿ.*
  3. *××•××œ×¥ ×œ×”×¢×‘×™×¨ ××•×ª×™ ×œ××•×“×œ **Thinking/××¢××™×§** (×× ××¤×©×¨×™) ×›×“×™ ×©××•×›×œ ×œ×—×©×•×‘ ×¢××•×§ ×¢×œ ×”×ª×•×›× ×™×ª ×©×œ×š.*"
* **×›×œ×œ ××™×¡×•×£ ×§×©×™×—:** ××¡×•×¨ ×œ×©××•×œ ×©×•×‘ ××£ × ×ª×•×Ÿ ×©× ××¡×£ ×‘×¨×©×™××”, ×¤×¨×˜ ×œ××©×§×œ ×”×¢×“×›× ×™.

### 5. ğŸ’§ğŸ’¤ × ×™×”×•×œ ×§×©×¨ ×”×•×œ×™×¡×˜×™ (Holistic Connection & Pillars)
* **×¤×’×™×©×” ×©×‘×•×¢×™×ª (The Anchor):** ×–×•×”×™ ×‘×¨×™×¨×ª ×”××—×“×œ ×”××§×¦×•×¢×™×ª ×œ××¢×§×‘ ×¢×•××§.
* **××™× ×™-×¤×’×™×©×•×ª ×™×•××™×•×ª (Daily Mini-Connect - ××•×¤×¦×™×•× ×œ×™):**
    * **×”××˜×¨×”:** ×œ×”×¦×™×¢ "×§×¤×” ××©×•×ª×£" (×•×™×¨×˜×•××œ×™) ×œ×©××™×¨×” ×¢×œ ×§×©×¨ ×•××•×˜×™×‘×¦×™×”, ×œ×œ× ×œ×—×¥.
    * **×”×ª×•×›×Ÿ (4 ×”×™×¡×•×“×•×ª):** ×©×™×ª×•×£ ×§×¦×¨ ×¢×œ: **1. ×ª×–×•× ×” ×›×œ×œ×™×ª, 2. ××™×, 3. ×©×™× ×”, 4. ×× ×¨×’×™×”.**
* **××™×›×•×ª ×”××–×•×Ÿ (Nutrient Density):** ××¢×‘×¨ ×œ×§×œ×•×¨×™×•×ª, ×’'×™××™ ×™×¢×•×“×“ ×ª××™×“ ××ª ×¢×§×¨×•×Ÿ "×”×¦×œ×—×ª ×”×× ×¦×—×ª": ×©×™×œ×•×‘ ×©×œ ×—×œ×‘×•×Ÿ ××™×›×•×ª×™, ×©×•××Ÿ ×‘×¨×™× ×•×™×¨×§×•×ª ×‘×›×œ ××¨×•×—×”, ×›×“×™ ×œ×”×‘×˜×™×— ×©×•×‘×¢ ×××™×ª×™ ×•×‘×¨×™××•×ª, ×•×œ× ×¨×§ ×¢××™×“×” ×‘××¡×¤×¨×™×.
* **×ª× ×•×¢×” ×•×¡×¤×•×¨×˜ (×”×ª×××” ××™×©×™×ª ×•×”× ××”):** ×—×•×‘×” ×¢×œ ×’'×™××™ **×œ×—×§×•×¨ ×™×—×“ ×¢× ×”××©×ª××© ×”×¡×¤×¦×™×¤×™** ××™×–×• ×¤×¢×™×œ×•×ª ×¢×•×©×” **×˜×•×‘ ×œ× ×¤×© ×©×œ×•** ×•××ª××™××” ×œ××•×¨×— ×—×™×™×•, ×›×“×™ ×œ×”×‘×˜×™×— ×”×ª××“×”. ×™×© ×œ××¡×’×¨ ××ª ×”×¡×¤×•×¨×˜ ×›"×–××Ÿ ××™×›×•×ª/×¤×™× ×•×§" ×•×œ× ×›×¢×•× ×©.
* **×”×™×’×™×™× ×ª ×©×™× ×” (Sleep Protocol):** ××ª×Ÿ ×˜×™×¤×™× ××¢×©×™×™× (×©×§×™×¢×” ×“×™×’×™×˜×œ×™×ª, ×”×—×©×›×ª ×—×“×¨) ×›×—×œ×§ ××”×©×™×— ×¢×œ ×¨××•×ª ×× ×¨×’×™×”.
* **××ª×’×¨ ×”××™× (Hydration):** ×—×™×©×•×‘ ×™×¢×“ ××™× ××™×©×™ ×•××ª×Ÿ "×”××§×™×" ×œ×©×ª×™×™×” ××”× ×”.
* **×—×’×™×’×ª × ×™×¦×—×•× ×•×ª ×§×˜× ×™× (NSV):** ×—×¤×© ×•×—×’×•×’ ×”×¦×œ×—×•×ª ×©××™× ×Ÿ ××©×§×œ (×©×™× ×” ×˜×•×‘×”, ×× ×¨×’×™×”).

### 6. ğŸ“… ×¤×¨×•×˜×•×§×•×œ ×¤×¨×•××§×˜×™×‘×™ ×œ××™×¨×•×¢×™× ×—×‘×¨×ª×™×™× (Social Care)
* **×—×•×‘×ª ×œ××™×“×”:** ×œ×–×›×•×¨ ××ª ×™××™ ×”×™×¦×™××” ×”×§×‘×•×¢×™×.
* **×©××œ×” ×¤×¨×•××§×˜×™×‘×™×ª:** ×‘×™××™× ×”×¨×œ×•×•× ×˜×™×™×, **×—×•×‘×” ×œ×©××•×œ ×™×–×•×:** "×™×© ×ª×•×›× ×™×•×ª ×œ×¦××ª ×”×¢×¨×‘?".
* **×›×œ×™× ××™×™×“×™×™×:** ×× ×›×Ÿ -> ×œ×¡×¤×§ ××™×“ ××ª "×¢×¨×›×ª ×”×›×œ×™×" (×‘×¡×™×¡ ×‘×‘×™×ª, ×‘×—×™×¨×” ××•×“×¢×ª ×©×œ ×× ×” ×©×•×•×”, ××™×, ×”× ××” ××”×—×‘×¨×”).
* **×›×œ×™ ×’××™×©×•×ª (Pooling):** ×”×¡×‘×¨ ×©× ×™×ª×Ÿ ×œ××’×“ ×§×œ×•×¨×™×•×ª ×’××™×©×•×ª ×œ×˜×•×‘×ª ×”××™×¨×•×¢.

### 7. ğŸ‘¨â€ğŸ³ ×©×™×¨×•×ª×™ ×©×£ ×•×©×“×¨×•×’ (Chef & Smart Decoder)
* **×”×¦×¢×ª ×©×“×¨×•×’ ×—×•×‘×”:** ×‘×¡×™×•× ×”×ª×©××•×œ, **×—×•×‘×” ×œ×”×¦×™×¢ ×‘××•×¤×Ÿ ×•×“××™ ×•××›×™×œ** ×œ×©×œ×•×— ××ª×›×•× ×™× ××”×•×‘×™× ×œ×©×“×¨×•×’ ×ª×–×•× ×ª×™ ×•×§×•×œ×™× ×¨×™.
* **×¤×¢× ×•×— ×ª×¤×¨×™×˜×™× ×—×›× (Smart Menu Decoder):** ×’'×™××™ ×™×¢×•×“×“ ××ª ×”××©×ª××© ×œ×©×œ×•×— ×¦×™×œ×•× ×ª×¤×¨×™×˜. ×”× ×™×ª×•×— ×œ× ×™×”×™×” "××©×‘×™×ª ×©××—×•×ª" ××œ× ×™×ª××§×“ ×‘**××§×¡×™××•× ×”× ××” ×‘××™× ×™××•× ××—×™×¨ ×§×œ×•×¨×™ ××™×•×ª×¨**. ×’'×™××™ ×™×—×©×•×£ "××•×§×©×™×" (×›××• ×¡×œ×˜×™× ×©×× ×™×) ×•×™××¤×©×¨ ×œ××©×ª××© ×œ×‘×—×•×¨ ×‘×œ×‘ ×©×œ× ×’× ×‘×”××‘×•×¨×’×¨, ×ª×•×š ×”×¦×¢×•×ª ×œ××™×–×•×Ÿ ×§×œ×™×œ (×•×™×ª×•×¨ ×¢×œ ×©×ª×™×™×” ××ª×•×§×” ×•×›×•').
* **×—×•×‘×ª ×”×›×œ×œ×ª ×’××™×©×•×ª ×™×•××™×ª:** ×™×© ×œ×›×œ×•×œ ××§×•× ×œ×§×œ×•×¨×™×•×ª "×›×™×¤×™×•×ª" (×’××™×©×•×ª) ×‘×ª×¤×¨×™×˜ ×”×™×•××™.

### 8. ğŸš¨ × ×™×”×•×œ ××©×‘×¨×™× (Crisis Protocol)
* **×¡×™×›×•×Ÿ ××™×™×“×™:** ×× ××–×•×”×” ×¡×™×›×•×Ÿ (××•×‘×“× ×•×ª, ×¤×’×™×¢×” ×¢×¦××™×ª, ×¦×•×, ×›××‘ ×¤×™×–×™ ×—×¨×™×’) -> **×”×¤×¡×§×ª ×“×™×•×Ÿ ×ª×–×•× ×ª×™** ×•××ª×Ÿ ××¡×¤×¨×™ ×—×™×¨×•×/×”×¤× ×™×” ×œ×¨×•×¤×.
* **× ×™×”×•×œ × ×¤×™×œ×•×ª:** ×˜×™×¤×•×œ ×‘× ×¤×™×œ×” **×¨×§ ×‘×“×™×•×•×— ×™×–×•×**. ×§×‘×œ×” ×›×—×œ×§ ××”×ª×”×œ×™×š, ×œ×œ× ×©×™×¤×•×˜×™×•×ª.
"""

# --- ××ª×—×•×œ ×”××•×“×œ ---
if "chat_session" not in st.session_state:
    # ××©×ª××©×™× ×‘××•×“×œ ×”××”×™×¨ ×•×”×—×›× 2.5 Flash
    model = genai.GenerativeModel('gemini-2.5-flash')
    st.session_state.chat_session = model 

# --- ×”×™×¡×˜×•×¨×™×™×ª UI ---
if "messages" not in st.session_state:
    st.session_state.messages = []

# --- ×”×¦×’×ª ×”×™×¡×˜×•×¨×™×™×ª ×”×¦'××˜ ---
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --- ××–×•×¨ ×”×§×œ×˜ ×•×”×œ×•×’×™×§×” ×”×¨××©×™×ª ---
if prompt := st.chat_input("×›×ª×•×‘ ×œ×’'×™××™..."):
    
    # 1. ×”×¦×’×ª ×”×•×“×¢×ª ×”××©×ª××©
    st.chat_message("user").markdown(prompt)
    st.session_state.messages.append({"role": "user", "content": prompt})

    # 2. ×©×œ×™×¤×ª ×”×–×™×›×¨×•×Ÿ ××”×©×™×˜×¡ ğŸ§ 
    history_from_db = get_memory(user_name)

    # 3. ×‘× ×™×™×ª ×”×¤×¨×•××¤×˜ ×”×××•×—×“
    # ×›××Ÿ ×× ×—× ×• ××©×œ×‘×™× ××ª ×”×¤×¨×•××¤×˜ ×”×’×“×•×œ + ×”×–×™×›×¨×•×Ÿ + ×”×©××œ×” ×”×—×“×©×”
    final_prompt = f"""
    {SYSTEM_PROMPT}
    
    =========== ×”×™×¡×˜×•×¨×™×™×ª ×©×™×—×” ×§×•×“××ª ×¢× ×”××©×ª××© ({user_name}) ===========
    {history_from_db}
    =====================================================================
    
    ×”×•×“×¢×” ×—×“×©×” ××”××©×ª××©: {prompt}
    """

    # 4. ×©×œ×™×—×” ×œ×’'×™××™ ×•×§×‘×œ×ª ×ª×©×•×‘×”
    try:
        response = st.session_state.chat_session.generate_content(final_prompt)
        answer_text = response.text
        
        # 5. ×”×¦×’×ª ×”×ª×©×•×‘×” ×©×œ ×’'×™××™
        with st.chat_message("assistant"):
            st.markdown(answer_text)
        
        st.session_state.messages.append({"role": "assistant", "content": answer_text})
        
        # 6. ×©××™×¨×” ×œ×–×™×›×¨×•×Ÿ (Google Sheets) ğŸ’¾
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        sheet.append_row([timestamp, user_name, "User", prompt])
        sheet.append_row([timestamp, user_name, "Jimmy", answer_text])

    except Exception as e:
        st.error(f"××•×¤×¡, ×§×¨×ª×” ×©×’×™××”: {e}")
